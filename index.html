<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IS TIME</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        :root {
            --neon-green: #00ff41;
            --neon-red: #ff3333;
            --dark-bg: #000000;
        }

        html, body {
            font-family: 'Orbitron', monospace;
            background: var(--dark-bg);
            color: var(--neon-green);
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--dark-bg);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        .logo-main {
            font-size: 3.5rem;
            font-weight: 300;
            letter-spacing: 1rem;
            text-transform: uppercase;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
            text-align: center;
        }

        .timer-display {
            font-size: 3.2rem;
            font-weight: 400;
            letter-spacing: 0.15rem;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 25px currentColor;
            transition: all 0.3s ease;
        }

        .timer-display.danger {
            color: var(--neon-red);
            text-shadow: 0 0 30px rgba(255, 51, 51, 0.6);
            animation: pulse-red 0.8s infinite;
        }

        .timer-display.frozen {
            color: #444;
            text-shadow: none;
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .splash-timer {
            font-size: 1.1rem;
            font-weight: 300;
            letter-spacing: 0.4rem;
            opacity: 0.7;
            margin-top: 1.5rem;
        }

        .hint-text {
            position: absolute;
            bottom: 12%;
            font-size: 0.6rem;
            letter-spacing: 0.2rem;
            opacity: 0.35;
            font-weight: 300;
            animation: blink 2s infinite;
            text-transform: uppercase;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.5; }
        }

        .rule-line {
            font-size: 0.85rem;
            font-weight: 300;
            letter-spacing: 0.12rem;
            margin: 1rem 0;
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.7s ease;
            text-align: center;
            max-width: 85%;
            line-height: 1.5;
        }

        .rule-line.show {
            opacity: 1;
            transform: translateY(0);
        }

        .input-field {
            background: transparent;
            border: 1px solid rgba(0, 255, 65, 0.25);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 300;
            padding: 18px 25px;
            text-align: center;
            letter-spacing: 0.15rem;
            width: 80%;
            max-width: 320px;
            margin: 0.8rem 0;
            outline: none;
            text-transform: uppercase;
        }

        .input-field:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.15);
        }

        .btn-primary {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.25rem;
            padding: 20px 50px;
            margin-top: 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary:hover, .btn-primary:active {
            background: rgba(0, 255, 65, 0.08);
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.25);
        }

        .btn-primary:disabled {
            opacity: 0.25;
            cursor: not-allowed;
            border-color: #333;
            color: #555;
        }

        #home {
            justify-content: flex-start;
            padding-top: 10vh;
        }

        .top-bar {
            position: absolute;
            top: 3vh;
            width: 90%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 300;
            opacity: 0.6;
            letter-spacing: 0.08rem;
        }

        .user-name-display {
            font-weight: 500;
            color: var(--neon-green);
        }

        .audio-toggle {
            cursor: pointer;
            padding: 5px 10px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            font-size: 0.9rem;
        }

        .heart-container {
            margin: 2.5vh 0;
            font-size: 1.8rem;
            animation: heartbeat 1s infinite;
            text-shadow: 0 0 15px rgba(255, 0, 64, 0.5);
        }

        .heart-container.fast {
            animation: heartbeat 0.5s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.25); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 85%;
            max-width: 340px;
            margin-top: 5vh;
        }

        .menu-btn {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 400;
            letter-spacing: 0.1rem;
            padding: 28px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            text-transform: uppercase;
            line-height: 1.5;
        }

        .menu-btn:active {
            background: rgba(0, 255, 65, 0.12);
            transform: scale(0.96);
        }

        .menu-btn:disabled {
            opacity: 0.15;
            cursor: not-allowed;
        }

        .screen-header {
            position: absolute;
            top: 3vh;
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 0.4rem;
            text-transform: uppercase;
        }

        .back-btn {
            position: absolute;
            top: 3vh;
            left: 5%;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.5;
            font-weight: 300;
        }

        #makeFriend {
            justify-content: flex-start;
            padding-top: 8vh;
        }

        .friend-section {
            width: 90%;
            max-width: 360px;
            margin: 2vh 0;
            text-align: center;
        }

        .section-label {
            font-size: 0.7rem;
            letter-spacing: 0.2rem;
            opacity: 0.5;
            margin-bottom: 1.5vh;
            text-transform: uppercase;
        }

        .separator {
            width: 60%;
            height: 1px;
            background: rgba(0, 255, 65, 0.15);
            margin: 2vh auto;
        }

        .qr-box {
            background: white;
            padding: 12px;
            display: inline-block;
            border-radius: 8px;
            margin: 1vh 0;
        }

        .code-text {
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 0.3rem;
            margin-top: 1vh;
            color: var(--neon-green);
        }

        .scanner-btn {
            background: rgba(0, 255, 65, 0.08);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            padding: 20px 40px;
            cursor: pointer;
            letter-spacing: 0.15rem;
            margin: 1vh 0;
        }

        .scanner-container {
            width: 260px;
            height: 260px;
            margin: 2vh auto;
            border: 2px solid var(--neon-green);
            position: relative;
            overflow: hidden;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 40%, rgba(0,255,65,0.1) 50%, transparent 60%);
            animation: scan 2s infinite;
            pointer-events: none;
        }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .manual-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 1vh;
        }

        .manual-input {
            width: 180px;
            margin: 0;
        }

        .manual-btn {
            padding: 18px 25px;
            margin: 0;
            font-size: 0.7rem;
        }

        .add-msg {
            font-size: 0.75rem;
            margin-top: 2vh;
            height: 1.5rem;
        }

        .friends-list-container {
            width: 88%;
            max-width: 360px;
            max-height: 65vh;
            overflow-y: auto;
            margin-top: 12vh;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 15px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .friend-item:active {
            background: rgba(0, 255, 65, 0.05);
        }

        .friend-name {
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 0.05rem;
        }

        .friend-time {
            font-size: 0.8rem;
            font-weight: 400;
            font-variant-numeric: tabular-nums;
        }

        .friend-time.danger {
            color: var(--neon-red);
        }

        .action-section {
            margin-top: 15vh;
            text-align: center;
            width: 85%;
        }

        .action-info {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-bottom: 3vh;
            line-height: 1.6;
        }

        .custom-select-container {
            position: relative;
            width: 100%;
            margin-bottom: 3vh;
        }

        .custom-select-trigger {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.3);
            padding: 18px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            letter-spacing: 0.05rem;
        }

        .custom-select-trigger::after {
            content: '‚ñº';
            font-size: 0.6rem;
            opacity: 0.6;
        }

        .custom-options {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #000;
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-top: none;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .custom-options.open {
            display: block;
        }

        .custom-option {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 255, 65, 0.1);
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-option:hover, .custom-option.selected {
            background: rgba(0, 255, 65, 0.1);
            box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .option-name {
            font-size: 0.9rem;
            font-weight: 400;
        }

        .option-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .no-friends-msg {
            padding: 30px;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .no-friends-btn {
            margin-top: 15px;
            padding: 12px 25px;
            font-size: 0.7rem;
        }

        .tokes-grid {
            width: 85%;
            max-width: 360px;
            margin-top: 3vh;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toke-btn {
            background: rgba(0, 255, 65, 0.03);
            border: 1px solid rgba(0, 255, 65, 0.2);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            font-weight: 300;
            padding: 20px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            line-height: 1.4;
        }

        .toke-btn:active {
            background: rgba(0, 255, 65, 0.12);
        }

        .toke-btn.used {
            opacity: 0.2;
            border-color: #333;
            pointer-events: none;
        }

        .toke-btn.selected {
            border-color: var(--neon-green);
            background: rgba(0, 255, 65, 0.15);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
        }

        .toke-reward {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--neon-green);
            font-weight: 500;
        }

        .frozen-screen {
            color: #555;
        }

        .frozen-timer {
            font-size: 2.2rem;
            margin: 2rem 0;
            letter-spacing: 0.2rem;
            color: #444;
        }

        .resurrect-info {
            font-size: 0.8rem;
            max-width: 80%;
            text-align: center;
            line-height: 1.6;
            margin-top: 2rem;
            opacity: 0.6;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .popup-overlay.active {
            display: flex;
            opacity: 1;
        }

        .popup-content {
            border: 1px solid var(--neon-green);
            background: #000;
            padding: 40px 30px;
            text-align: center;
            max-width: 85%;
            animation: popupIn 0.3s ease;
        }

        @keyframes popupIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            letter-spacing: 0.1rem;
        }

        .popup-message {
            font-size: 0.85rem;
            font-weight: 300;
            line-height: 1.5;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .popup-time {
            font-size: 1.8rem;
            color: var(--neon-green);
            margin: 1rem 0;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .popup-btn {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            padding: 15px 40px;
            cursor: pointer;
            letter-spacing: 0.15rem;
        }

        .inbox-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--neon-red);
            color: #000;
            font-size: 0.6rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
        }
    </style>
</head>
<body>

    <!-- Popup -->
    <div class="popup-overlay" id="popup">
        <div class="popup-content">
            <div class="popup-title" id="popupTitle">NOTIFICACI√ìN</div>
            <div class="popup-message" id="popupMessage">Mensaje</div>
            <div class="popup-time hidden" id="popupTime">+00:00</div>
            <button class="popup-btn" onclick="closePopup()">ACEPTAR</button>
        </div>
    </div>

    <!-- 1. SPLASH 1 -->
    <div id="splash1" class="screen active">
        <div class="logo-main">IS TIME</div>
        <div class="splash-timer" id="globalCountdown">24:00:00</div>
        <div class="hint-text">TOCAR PARA CONTINUAR</div>
    </div>

    <!-- 2. SPLASH 2 -->
    <div id="splash2" class="screen">
        <div class="rule-line" id="rule1">TU TIEMPO DEFINE TU EXISTENCIA</div>
        <div class="rule-line" id="rule2">GANA TIEMPO CON PERSONAS REALES</div>
        <div class="rule-line" id="rule3">CUANDO LLEGAS A CERO, DESAPARECES</div>
        <div class="hint-text">TOCAR PARA INICIAR</div>
    </div>

    <!-- 3. REGISTRO -->
    <div id="register" class="screen">
        <div class="logo-main" style="font-size: 2rem; margin-bottom: 3rem;">IDENTIDAD</div>
        <input type="text" class="input-field" id="usernameInput" placeholder="TU NOMBRE" maxlength="12">
        <div class="code-text" id="idPreview" style="font-size: 1rem; opacity: 0.5;">ID: ----</div>
        <button class="btn-primary" id="startBtn" disabled>INICIAR</button>
    </div>

    <!-- 4. HOME -->
    <div id="home" class="screen">
        <div class="top-bar">
            <span class="user-name-display" id="userNameDisplay">----</span>
            <span class="audio-toggle" id="audioToggle" onclick="toggleAudio()">üîá</span>
        </div>
        
        <div class="timer-display" id="mainTimer">72:00:00</div>
        <div style="font-size: 0.8rem; opacity: 0.5; margin-top: 1vh; letter-spacing: 0.1rem;" id="friendsCount">0 ALIADOS</div>
        
        <div class="heart-container" id="heartBeat">‚ô•</div>
        
        <div class="menu-grid">
            <button class="menu-btn" onclick="showScreen('makeFriend')">MAKE<br>FRIEND</button>
            <button class="menu-btn" onclick="showScreen('friendsList')">ALIADOS<br>LIST</button>
            <button class="menu-btn" onclick="showScreen('sendTime')" style="position: relative;">
                SEND<br>TIME
                <span class="inbox-badge hidden" id="inboxBadge">0</span>
            </button>
            <button class="menu-btn" onclick="showScreen('playTokes')">PLAY<br>TOKES</button>
        </div>
    </div>

    <!-- 5. MAKE FRIEND -->
    <div id="makeFriend" class="screen">
        <div class="back-btn" onclick="showScreen('home')">‚Üê VOLVER</div>
        <div class="screen-header">CONEXI√ìN</div>
        
        <div class="friend-section">
            <div class="section-label">Tu C√≥digo - Escanea para Conectar</div>
            <div class="qr-box" id="qrContainer" style="width: 140px; height: 140px;"></div>
            <div class="code-text" id="myCode">------</div>
        </div>

        <div class="separator"></div>

        <div class="friend-section">
            <div class="section-label">Escanear Aliado</div>
            <button class="scanner-btn" onclick="toggleScanner()" id="scannerBtn">ABRIR C√ÅMARA</button>
            <div class="scanner-container hidden" id="scannerWrapper">
                <div class="scanner-overlay"></div>
                <div id="qrReader" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <div class="separator"></div>

        <div class="friend-section">
            <div class="section-label">C√≥digo Manual</div>
            <div class="manual-row">
                <input type="text" class="input-field manual-input" id="friendCodeInput" placeholder="ABC123" maxlength="6">
                <button class="btn-primary manual-btn" onclick="addFriendManual()">OK</button>
            </div>
            <div class="add-msg" id="addFriendMsg"></div>
        </div>
    </div>

    <!-- 6. FRIENDS LIST -->
    <div id="friendsList" class="screen">
        <div class="back-btn" onclick="showScreen('home')">‚Üê VOLVER</div>
        <div class="screen-header">ALIADOS</div>
        <div class="friends-list-container" id="friendsListContainer"></div>
    </div>

    <!-- 7. SEND TIME -->
    <div id="sendTime" class="screen">
        <div class="back-btn" onclick="showScreen('home')">‚Üê VOLVER</div>
        <div class="screen-header">REGALO</div>
        
        <div class="action-section">
            <div class="action-info">
                1 REGALO/D√çA ‚Üí +1:00:00 ALIADO<br>
                <span id="giftStatus" style="color: var(--neon-green);">DISPONIBLE</span>
            </div>
            
            <div class="custom-select-container" id="giftSelectContainer">
                <div class="custom-select-trigger" onclick="toggleGiftSelect()">
                    <span id="giftTriggerText">SELECCIONAR ALIADO</span>
                </div>
                <div class="custom-options" id="giftOptions"></div>
            </div>
            
            <button class="btn-primary" id="sendGiftBtn" onclick="sendGift()" disabled>ENVIAR TIEMPO</button>
        </div>
    </div>

    <!-- 8. PLAY TOKES -->
    <div id="playTokes" class="screen">
        <div class="back-btn" onclick="showScreen('home')">‚Üê VOLVER</div>
        <div class="screen-header">TOKES</div>
        
        <div class="action-section" style="margin-top: 10vh;">
            <div class="action-info" style="font-size: 0.7rem;">
                5 TOKES/D√çA A 5 ALIADOS DISTINTOS<br>
                USA LOS 5 ‚Üí +6:00:00 BONUS<br>
                <span id="tokesLeft" style="color: var(--neon-green);">5 restantes</span>
            </div>
            
            <div class="custom-select-container" id="tokeSelectContainer" style="margin-bottom: 2vh;">
                <div class="custom-select-trigger" onclick="toggleTokeSelect()">
                    <span id="tokeTriggerText">SELECCIONAR ALIADO</span>
                </div>
                <div class="custom-options" id="tokeOptions"></div>
            </div>
        </div>

        <div class="tokes-grid" id="tokesContainer"></div>
    </div>

    <!-- 9. CONGELADO -->
    <div id="frozen" class="screen frozen-screen">
        <div class="logo-main" style="font-size: 2.5rem; color: #444; text-shadow: none; margin-bottom: 1rem;">CONGELADO</div>
        <div class="frozen-timer" id="resurrectTimer">48:00:00</div>
        <div style="font-size: 4rem; opacity: 0.2;">‚úï</div>
        <div class="resurrect-info" id="frozenInfo">
            D√çA 1: Perder√°s 2 aliados<br>
            Espera 48h para resucitar con 12:00:00
        </div>
    </div>

    <script>
        // ==================== ESTADO ====================
        const state = {
            user: null,
            friends: [],
            lastUpdate: Date.now(),
            dailyActions: {
                giftsSent: 0,
                tokesUsed: 0,
                lastReset: Date.now(),
                gotBonus: false,
                usedFriends: []
            },
            frozenState: {
                isFrozen: false,
                frozenAt: null,
                dayCount: 0
            },
            inbox: { gifts: [], tokes: [] },
            audioEnabled: false,
            selectedGiftFriend: null,
            selectedTokeFriend: null
        };

        const REWARDS = [24, 24, 12, 6, 0];
        const TOKE_MESSAGES = [
            { text: "¬°P√°same un poco de vida, colega!", type: "life", reward: 2, emoji: "üòé‚è≥üòÇüî•" },
            { text: "Me acuerdo de ti", type: "social", reward: 0, emoji: "üòé‚è≥üòÇüî•" },
            { text: "¬øQu√© pasa, m√°quina?", type: "social", reward: 0, emoji: "üòé‚è≥üòÇüî•" },
            { text: "Vamos a liarla", type: "social", reward: 0, emoji: "üòé‚è≥üòÇüî•" },
            { text: "No me falles hoy", type: "social", reward: 0, emoji: "üòé‚è≥üòÇüî•" }
        ];

        let html5QrCode = null;
        let audioContext = null;
        let heartbeatInterval = null;

        // ==================== AUDIO ====================
        function initAudio() {
            if (audioContext) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function activateAudio() {
            initAudio();
            if (audioContext.state === 'suspended') audioContext.resume();
            state.audioEnabled = true;
            showScreen('register');
        }

        function toggleAudio() {
            if (!audioContext) { initAudio(); audioContext.resume(); }
            state.audioEnabled = !state.audioEnabled;
            updateAudioIcon();
            updateHeartbeat();
        }

        function updateAudioIcon() {
            document.getElementById('audioToggle').textContent = state.audioEnabled ? 'üîä' : 'üîá';
        }

        function playHeartbeat() {
            if (!state.audioEnabled || !audioContext) return;
            stopHeartbeat();
            
            const hours = state.user ? state.user.timeMs / 3600000 : 72;
            let bpm = 60;
            if (state.frozenState.isFrozen) bpm = 30;
            else if (hours < 12) bpm = 120;
            
            const interval = 60000 / bpm;
            
            heartbeatInterval = setInterval(() => {
                if (!state.audioEnabled || !audioContext) return;
                const now = audioContext.currentTime;
                
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.frequency.setValueAtTime(80, now);
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.start(now);
                osc1.stop(now + 0.1);
                
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.frequency.setValueAtTime(60, now + 0.12);
                    osc2.type = 'sine';
                    gain2.gain.setValueAtTime(0.25, now + 0.12);
                    gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.start(now + 0.12);
                    osc2.stop(now + 0.2);
                }, 100);
            }, interval);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
        }

        function updateHeartbeat() {
            stopHeartbeat();
            if (state.audioEnabled) {
                const homeActive = document.getElementById('home').classList.contains('active');
                const frozenActive = document.getElementById('frozen').classList.contains('active');
                if (homeActive || frozenActive) playHeartbeat();
            }
        }

        // ==================== UTILIDADES ====================
        function generateId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 6; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
            return id;
        }

        function formatTime(ms) {
            if (ms <= 0) return "00:00:00";
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function formatShortTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            return `${h}h ${m}m`;
        }

        function saveState() {
            state.lastUpdate = Date.now();
            localStorage.setItem('istime_data_v5', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('istime_data_v5');
            if (saved) {
                Object.assign(state, JSON.parse(saved));
                const now = Date.now();
                const elapsed = now - state.lastUpdate;
                
                if (state.user && !state.frozenState.isFrozen) {
                    state.user.timeMs = Math.max(0, state.user.timeMs - elapsed);
                    state.friends.forEach(f => f.timeMs = Math.max(0, f.timeMs - elapsed));
                }
                state.lastUpdate = now;
                
                if (state.user && state.user.timeMs <= 0 && !state.frozenState.isFrozen) {
                    enterFrozenState();
                }
                return true;
            }
            return false;
        }

        // ==================== POPUP ====================
        function showPopup(title, message, timeBonus = null) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').innerHTML = message;
            const timeEl = document.getElementById('popupTime');
            if (timeBonus) {
                timeEl.textContent = `+${formatTime(timeBonus)}`;
                timeEl.classList.remove('hidden');
            } else {
                timeEl.classList.add('hidden');
            }
            document.getElementById('popup').classList.add('active');
            if (navigator.vibrate) navigator.vibrate(timeBonus ? [100,50,100,50,200] : [100,50,100]);
        }

        function closePopup() {
            document.getElementById('popup').classList.remove('active');
        }

        // ==================== NAVEGACI√ìN ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
                setTimeout(() => { if (!s.classList.contains('active')) s.style.display = 'none'; }, 500);
            });
            
            const target = document.getElementById(screenId);
            target.style.display = 'flex';
            setTimeout(() => target.classList.add('active'), 10);
            
            updateHeartbeat();
            
            if (screenId === 'home') updateHome();
            if (screenId === 'friendsList') renderFriendsList();
            if (screenId === 'sendTime') updateSendTime();
            if (screenId === 'playTokes') updatePlayTokes();
            if (screenId === 'makeFriend') updateMakeFriend();
            if (screenId === 'frozen') updateFrozen();
        }

        // ==================== SPLASH ====================
        let globalCountdown = 24 * 3600;
        setInterval(() => {
            globalCountdown--;
            if (globalCountdown < 0) globalCountdown = 24 * 3600;
            const el = document.getElementById('globalCountdown');
            if (el) el.textContent = formatTime(globalCountdown * 1000);
        }, 1000);

        document.getElementById('splash1').addEventListener('click', () => {
            if (state.user) {
                checkInbox();
                showScreen('home');
            } else {
                showScreen('splash2');
                setTimeout(() => {
                    document.getElementById('rule1').classList.add('show');
                    setTimeout(() => document.getElementById('rule2').classList.add('show'), 800);
                    setTimeout(() => document.getElementById('rule3').classList.add('show'), 1600);
                }, 100);
            }
        });

        // ==================== REGISTRO ====================
        const usernameInput = document.getElementById('usernameInput');
        usernameInput.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 12);
            e.target.value = val;
            document.getElementById('startBtn').disabled = val.length < 2;
            document.getElementById('idPreview').textContent = `ID: ${generateId()}`;
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            state.user = {
                id: generateId(),
                name: usernameInput.value,
                timeMs: 72 * 3600000,
                createdAt: Date.now(),
                friendsMade: 0
            };
            state.lastUpdate = Date.now();
            saveState();
            showScreen('home');
        });

        // ==================== HOME ====================
        function updateHome() {
            if (!state.user) return;
            
            const timerEl = document.getElementById('mainTimer');
            const heartEl = document.getElementById('heartBeat');
            
            document.getElementById('userNameDisplay').textContent = state.user.name;
            document.getElementById('friendsCount').textContent = `${state.friends.length} ALIADOS`;
            
            timerEl.textContent = formatTime(state.user.timeMs);
            
            const hours = state.user.timeMs / 3600000;
            timerEl.classList.remove('danger', 'frozen');
            heartEl.classList.remove('fast');
            
            if (state.user.timeMs <= 0) {
                timerEl.classList.add('frozen');
                enterFrozenState();
                return;
            } else if (hours < 12) {
                timerEl.classList.add('danger');
                heartEl.classList.add('fast');
            }
            
            updateAudioIcon();
            
            const totalInbox = state.inbox.gifts.length + state.inbox.tokes.length;
            const badge = document.getElementById('inboxBadge');
            badge.textContent = totalInbox;
            badge.classList.toggle('hidden', totalInbox === 0);
        }

        setInterval(() => {
            if (state.user && !state.frozenState.isFrozen) {
                state.user.timeMs = Math.max(0, state.user.timeMs - 1000);
                state.friends.forEach(f => f.timeMs = Math.max(0, f.timeMs - 1000));
                state.lastUpdate = Date.now();
                
                if (state.user.timeMs <= 0) enterFrozenState();
                
                if (document.getElementById('home').classList.contains('active')) updateHome();
                if (document.getElementById('friendsList').classList.contains('active')) renderFriendsList();
                
                saveState();
            }
        }, 1000);

        // ==================== INBOX ====================
        function checkInbox() {
            let message = '';
            let totalTime = 0;
            
            state.inbox.gifts.forEach(g => {
                totalTime += g.amount;
                message += `‚úì ${g.fromName} te envi√≥ ${formatTime(g.amount)}<br>`;
            });
            
            state.inbox.tokes.forEach(t => {
                if (t.reward > 0) {
                    totalTime += t.reward * 3600000;
                    message += `‚úì ${t.fromName}: "${t.message}" ‚Üí +${t.reward}:00:00<br>`;
                } else {
                    message += `‚úì ${t.fromName}: "${t.message}"<br>`;
                }
            });
            
            if (totalTime > 0) {
                state.user.timeMs += totalTime;
                showPopup('TIEMPO RECIBIDO', message, totalTime);
                state.inbox.gifts = [];
                state.inbox.tokes = [];
                saveState();
            }
        }

        // ==================== MAKE FRIEND ====================
        function updateMakeFriend() {
            if (!state.user) return;
            document.getElementById('myCode').textContent = state.user.id;
            
            const container = document.getElementById('qrContainer');
            container.innerHTML = '';
            new QRCode(container, {
                text: state.user.id,
                width: 116,
                height: 116,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function toggleScanner() {
            const wrapper = document.getElementById('scannerWrapper');
            const btn = document.getElementById('scannerBtn');
            
            if (wrapper.classList.contains('hidden')) {
                wrapper.classList.remove('hidden');
                btn.textContent = 'CERRAR C√ÅMARA';
                startScanner();
            } else {
                wrapper.classList.add('hidden');
                btn.textContent = 'ABRIR C√ÅMARA';
                stopScanner();
            }
        }

        function startScanner() {
            if (!html5QrCode) html5QrCode = new Html5Qrcode('qrReader');
            
            html5QrCode.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 200, height: 200 } },
                (decodedText) => {
                    stopScanner();
                    document.getElementById('scannerWrapper').classList.add('hidden');
                    document.getElementById('scannerBtn').textContent = 'ABRIR C√ÅMARA';
                    addFriendByCode(decodedText);
                },
                () => {}
            ).catch(() => {
                showPopup('ERROR', 'No se pudo acceder a la c√°mara');
            });
        }

        function stopScanner() {
            if (html5QrCode) html5QrCode.stop().catch(() => {});
        }

        function addFriendManual() {
            addFriendByCode(document.getElementById('friendCodeInput').value.toUpperCase());
        }

        function addFriendByCode(code) {
            const msgEl = document.getElementById('addFriendMsg');
            
            if (!code || code.length !== 6) {
                msgEl.textContent = 'C√ìDIGO INV√ÅLIDO';
                msgEl.style.color = 'var(--neon-red)';
                return;
            }
            if (code === state.user.id) {
                msgEl.textContent = 'NO PUEDES A√ëADIRTE A TI MISMO';
                msgEl.style.color = 'var(--neon-red)';
                return;
            }
            if (state.friends.find(f => f.id === code)) {
                msgEl.textContent = 'YA ES TU ALIADO';
                msgEl.style.color = 'var(--neon-red)';
                return;
            }
            
            // Pedir nombre del amigo
            const friendName = prompt('Nombre del aliado:', `ALIADO_${code.slice(0,3)}`);
            if (!friendName) return;
            
            const rewardHours = REWARDS[Math.min(state.user.friendsMade, 4)];
            const newFriend = {
                id: code,
                name: friendName.toUpperCase(),
                timeMs: (20 + Math.random() * 40) * 3600000,
                addedAt: Date.now()
            };
            
            state.friends.push(newFriend);
            state.user.friendsMade++;
            
            if (rewardHours > 0) {
                state.user.timeMs += rewardHours * 3600000;
                showPopup('NUEVO ALIADO', `Conectado con ${newFriend.name}`, rewardHours * 3600000);
            } else {
                showPopup('ALIADO A√ëADIDO', `${newFriend.name}<br>Sin recompensa`, 0);
            }
            
            document.getElementById('friendCodeInput').value = '';
            saveState();
            setTimeout(() => showScreen('home'), 2000);
        }

        // ==================== FRIENDS LIST ====================
        function renderFriendsList() {
            const container = document.getElementById('friendsListContainer');
            container.innerHTML = '';
            
            const sorted = [...state.friends].sort((a, b) => a.timeMs - b.timeMs);
            
            sorted.forEach(f => {
                const div = document.createElement('div');
                div.className = 'friend-item';
                const hours = f.timeMs / 3600000;
                
                div.innerHTML = `
                    <div>
                        <div class="friend-name">${f.name}</div>
                        <div style="font-size:0.6rem;opacity:0.4;letter-spacing:0.05rem;">${f.id}</div>
                    </div>
                    <div class="friend-time ${hours < 12 ? 'danger' : ''}">${formatTime(f.timeMs)}</div>
                `;
                
                container.appendChild(div);
            });
            
            if (state.friends.length === 0) {
                container.innerHTML = '<div style="text-align:center;opacity:0.5;margin-top:40%;font-size:0.8rem;">SIN ALIADOS A√öN</div>';
            }
        }

        // ==================== CUSTOM SELECTS ====================
        function toggleGiftSelect() {
            document.getElementById('giftOptions').classList.toggle('open');
        }

        function toggleTokeSelect() {
            document.getElementById('tokeOptions').classList.toggle('open');
        }

        function selectGiftFriend(friendId, friendName) {
            state.selectedGiftFriend = friendId;
            document.getElementById('giftTriggerText').textContent = friendName;
            document.getElementById('giftOptions').classList.remove('open');
            document.getElementById('sendGiftBtn').disabled = false;
        }

        function selectTokeFriend(friendId, friendName) {
            state.selectedTokeFriend = friendId;
            document.getElementById('tokeTriggerText').textContent = friendName;
            document.getElementById('tokeOptions').classList.remove('open');
            renderTokes();
        }

        // ==================== SEND TIME ====================
        function updateSendTime() {
            const options = document.getElementById('giftOptions');
            options.innerHTML = '';
            state.selectedGiftFriend = null;
            document.getElementById('giftTriggerText').textContent = 'SELECCIONAR ALIADO';
            document.getElementById('sendGiftBtn').disabled = true;
            
            if (state.friends.length === 0) {
                options.innerHTML = `
                    <div class="no-friends-msg">
                        NO TIENES ALIADOS<br>
                        <button class="btn-primary no-friends-btn" onclick="showScreen('makeFriend')">A√ëADIR ALIADO</button>
                    </div>`;
            } else {
                state.friends.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'custom-option';
                    div.innerHTML = `<span class="option-name">${f.name}</span><span class="option-time">${formatShortTime(f.timeMs)}</span>`;
                    div.onclick = () => selectGiftFriend(f.id, f.name);
                    options.appendChild(div);
                });
            }
            
            const canGift = state.dailyActions.giftsSent < 1;
            document.getElementById('giftStatus').textContent = canGift ? 'DISPONIBLE' : 'YA USADO HOY';
            document.getElementById('giftStatus').style.color = canGift ? 'var(--neon-green)' : '#555';
        }

        function sendGift() {
            if (!state.selectedGiftFriend) return;
            if (state.dailyActions.giftsSent >= 1) {
                showPopup('L√çMITE', 'Ya enviaste un regalo hoy');
                return;
            }
            
            const friend = state.friends.find(f => f.id === state.selectedGiftFriend);
            
            // Sistema de c√≥digos de reclamo para MVP sin backend
            const claimCode = generateClaimCode();
            const claimData = {
                type: 'gift',
                fromId: state.user.id,
                fromName: state.user.name,
                toId: friend.id,
                toName: friend.name,
                amount: 3600000,
                code: claimCode,
                timestamp: Date.now(),
                claimed: false
            };
            
            // Guardar en localStorage global de reclamos
            let claims = JSON.parse(localStorage.getItem('istime_claims') || '[]');
            claims.push(claimData);
            localStorage.setItem('istime_claims', JSON.stringify(claims));
            
            // Mostrar c√≥digo al usuario para que lo comparta
            showPopup('REGALO ENVIADO', `Enviaste 1:00:00 a ${friend.name}<br><br>C√ìDIGO DE RECLAMO:<br><span style="font-size:2rem;letter-spacing:0.3rem;">${claimCode}</span><br><br>Dale este c√≥digo a ${friend.name} para que reclame su tiempo`, 0);
            
            state.dailyActions.giftsSent = 1;
            saveState();
            setTimeout(() => showScreen('home'), 4000);
        }

        // ==================== PLAY TOKES ====================
        function updatePlayTokes() {
            const options = document.getElementById('tokeOptions');
            options.innerHTML = '';
            state.selectedTokeFriend = null;
            document.getElementById('tokeTriggerText').textContent = 'SELECCIONAR ALIADO';
            
            const availableFriends = state.friends.filter(f => !state.dailyActions.usedFriends.includes(f.id));
            
            if (availableFriends.length === 0) {
                if (state.friends.length === 0) {
                    options.innerHTML = `
                        <div class="no-friends-msg">
                            NO TIENES ALIADOS<br>
                            <button class="btn-primary no-friends-btn" onclick="showScreen('makeFriend')">A√ëADIR ALIADO</button>
                        </div>`;
                } else {
                    options.innerHTML = '<div class="no-friends-msg">YA USASTE TOKES CON TODOS TUS ALIADOS HOY</div>';
                }
            } else {
                availableFriends.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'custom-option';
                    div.innerHTML = `<span class="option-name">${f.name}</span><span class="option-time">${formatShortTime(f.timeMs)}</span>`;
                    div.onclick = () => selectTokeFriend(f.id, f.name);
                    options.appendChild(div);
                });
            }
            
            renderTokes();
        }

        function renderTokes() {
            const container = document.getElementById('tokesContainer');
            container.innerHTML = '';
            
            const remaining = 5 - state.dailyActions.tokesUsed;
            document.getElementById('tokesLeft').textContent = `${remaining} restantes${remaining === 0 ? ' - BONUS DESBLOQUEADO' : ''}`;
            
            TOKE_MESSAGES.forEach((toke, idx) => {
                const btn = document.createElement('button');
                btn.className = 'toke-btn';
                const used = state.dailyActions.tokesUsed > idx;
                if (used) btn.classList.add('used');
                if (!used && state.selectedTokeFriend) btn.classList.add('selected');
                
                btn.innerHTML = `
                    <div style="font-weight:400;margin-bottom:3px;">${toke.text}</div>
                    <div style="font-size:0.6rem;opacity:0.6;">${toke.emoji}</div>
                    ${toke.reward > 0 && !used ? `<span class="toke-reward">+${toke.reward}:00</span>` : ''}
                `;
                
                btn.onclick = () => sendToke(idx);
                container.appendChild(btn);
            });
            
            if (remaining === 0 && !state.dailyActions.gotBonus) {
                state.user.timeMs += 6 * 3600000;
                state.dailyActions.gotBonus = true;
                saveState();
                setTimeout(() => showPopup('BONUS DESBLOQUEADO', '¬°Usaste 5 tokes! +6:00:00', 6 * 3600000), 500);
            }
        }

        function sendToke(index) {
            if (!state.selectedTokeFriend) {
                showPopup('SELECCIONA ALIADO', 'Primero elige a qui√©n enviar el toke');
                return;
            }
            if (state.dailyActions.tokesUsed >= 5) {
                showPopup('L√çMITE ALCANZADO', 'Ya usaste tus 5 tokes de hoy');
                return;
            }
            
            const toke = TOKE_MESSAGES[index];
            const friend = state.friends.find(f => f.id === state.selectedTokeFriend);
            
            // Sistema de c√≥digos de reclamo
            const claimCode = generateClaimCode();
            const claimData = {
                type: 'toke',
                fromId: state.user.id,
                fromName: state.user.name,
                toId: friend.id,
                toName: friend.name,
                message: toke.text,
                reward: toke.reward,
                code: claimCode,
                timestamp: Date.now(),
                claimed: false
            };
            
            let claims = JSON.parse(localStorage.getItem('istime_claims') || '[]');
            claims.push(claimData);
            localStorage.setItem('istime_claims', JSON.stringify(claims));
            
            // Aplicar efecto local al emisor
            let timeGained = 0;
            if (toke.reward > 0) {
                state.user.timeMs += toke.reward * 3600000;
                timeGained = toke.reward * 3600000;
            }
            
            state.dailyActions.tokesUsed++;
            state.dailyActions.usedFriends.push(state.selectedTokeFriend);
            
            saveState();
            
            showPopup('TOKE ENVIADO', `A ${friend.name}:<br>"${toke.text}"<br><br>C√ìDIGO DE RECLAMO:<br><span style="font-size:2rem;letter-spacing:0.3rem;">${claimCode}</span><br><br>Dale este c√≥digo a ${friend.name}`, timeGained);
            
            state.selectedTokeFriend = null;
            document.getElementById('tokeTriggerText').textContent = 'SELECCIONAR ALIADO';
            updatePlayTokes();
        }

        function generateClaimCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        // Funci√≥n para reclamar (accesible desde cualquier pantalla)
        function checkClaims() {
            if (!state.user) return;
            
            const claims = JSON.parse(localStorage.getItem('istime_claims') || '[]');
            const myClaims = claims.filter(c => c.toId === state.user.id && !c.claimed);
            
            if (myClaims.length > 0) {
                let message = '';
                let totalTime = 0;
                
                myClaims.forEach(c => {
                    if (c.type === 'gift') {
                        totalTime += c.amount;
                        message += `‚úì ${c.fromName} te envi√≥ ${formatTime(c.amount)}<br>`;
                    } else if (c.type === 'toke') {
                        if (c.reward > 0) {
                            totalTime += c.reward * 3600000;
                            message += `‚úì ${c.fromName}: "${c.message}" ‚Üí +${c.reward}:00:00<br>`;
                        } else {
                            message += `‚úì ${c.fromName}: "${c.message}"<br>`;
                        }
                    }
                    c.claimed = true;
                });
                
                // Actualizar claims como reclamados
                localStorage.setItem('istime_claims', JSON.stringify(claims));
                
                if (totalTime > 0) {
                    state.user.timeMs += totalTime;
                    saveState();
                    showPopup('TIEMPO RECIBIDO', message, totalTime);
                }
            }
        }

        // Bot√≥n para reclamar manualmente (en home)
        function showClaimDialog() {
            const code = prompt('Introduce c√≥digo de reclamo:');
            if (!code) return;
            
            const claims = JSON.parse(localStorage.getItem('istime_claims') || '[]');
            const claim = claims.find(c => c.code === code.toUpperCase() && !c.claimed);
            
            if (!claim) {
                showPopup('ERROR', 'C√≥digo inv√°lido o ya reclamado');
                return;
            }
            
            if (claim.toId !== state.user.id) {
                showPopup('ERROR', 'Este c√≥digo no es para ti');
                return;
            }
            
            claim.claimed = true;
            localStorage.setItem('istime_claims', JSON.stringify(claims));
            
            let timeGained = 0;
            if (claim.type === 'gift') {
                timeGained = claim.amount;
            } else if (claim.type === 'toke' && claim.reward > 0) {
                timeGained = claim.reward * 3600000;
            }
            
            state.user.timeMs += timeGained;
            saveState();
            
            showPopup('RECLAMADO', `De ${claim.fromName}:<br>${claim.type === 'gift' ? formatTime(claim.amount) : claim.message}`, timeGained);
        }

        // ==================== CONGELADO ====================
        function enterFrozenState() {
            if (state.frozenState.isFrozen) return;
            state.frozenState.isFrozen = true;
            state.frozenState.frozenAt = Date.now();
            state.frozenState.dayCount = 0;
            saveState();
            showScreen('frozen');
        }

        function updateFrozen() {
            if (!state.frozenState.isFrozen) return;
            
            const frozenTime = Date.now() - state.frozenState.frozenAt;
            const hoursFrozen = Math.floor(frozenTime / 3600000);
            const resurrectTime = Math.max(0, (48 * 3600000) - frozenTime);
            
            document.getElementById('resurrectTimer').textContent = formatTime(resurrectTime);
            
            let infoText = '';
            if (hoursFrozen < 24) {
                infoText = `D√çA 1: Pronto perder√°s 2 aliados<br>Espera ${formatTime(resurrectTime)} para resucitar con 12:00:00`;
            } else if (hoursFrozen < 48) {
                infoText = `D√çA 2: Perdiste 2 aliados<br>Pronto perder√°s el resto<br>Espera ${formatTime(resurrectTime)} para resucitar`;
            } else {
                resurrectNow();
                return;
            }
            
            const currentDay = Math.floor(hoursFrozen / 24);
            if (currentDay > state.frozenState.dayCount && state.friends.length > 0) {
                state.frozenState.dayCount = currentDay;
                if (currentDay === 1) state.friends = state.friends.slice(0, Math.max(0, state.friends.length - 2));
                else if (currentDay === 2) state.friends = [];
                saveState();
            }
            
            document.getElementById('frozenInfo').innerHTML = infoText;
        }

        function resurrectNow() {
            state.frozenState.isFrozen = false;
            state.frozenState.frozenAt = null;
            state.user.timeMs = 12 * 3600000;
            state.friends = [];
            state.dailyActions = { giftsSent: 0, tokesUsed: 0, lastReset: Date.now(), gotBonus: false, usedFriends: [] };
            saveState();
            showPopup('RESURRECCI√ìN', 'Has vuelto con 12:00:00<br>0 aliados<br>Empieza de nuevo', 12 * 3600000);
            setTimeout(() => showScreen('home'), 3000);
        }

        // ==================== EVENT LISTENER PARA SPLASH2 (CORRECCI√ìN) ====================
        document.getElementById('splash2').addEventListener('click', () => {
            showScreen('register');
        });

        // ==================== INIT ====================
        function init() {
            if (loadState() && state.user) {
                checkClaims();
                if (state.frozenState.isFrozen) showScreen('frozen');
                else showScreen('home');
            }
        }

        function checkDailyReset() {
            if (!state.user) return;
            const hoursSince = (Date.now() - state.dailyActions.lastReset) / 3600000;
            if (hoursSince >= 24) {
                state.dailyActions = { giftsSent: 0, tokesUsed: 0, lastReset: Date.now(), gotBonus: false, usedFriends: [] };
                saveState();
            }
        }

        init();
        checkDailyReset();
        setInterval(checkDailyReset, 3600000);
        setInterval(checkClaims, 10000); // Verificar reclamos cada 10 segundos
        window.addEventListener('beforeunload', saveState);
        document.addEventListener('gesturestart', e => e.preventDefault());
    </script>
</body>
</html>
